<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EDITAR POST</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- font-awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body class="bg-gray-900">
  <main class="bg-gray-400 max-w-screen-lg p-8 m-auto space-y-8">

    <a class="text-blue-700 hover:text-white font-semibold" href="/post/novo">NOVO POST</a>
    <a class="text-blue-700 hover:text-white font-semibold ml-5" href="/">HOME</a>

    <section>
      <h2 class="font-semibold text-lg ">POSTAGENS</h2>

      <select class=" px-4 py-2 w-full" id="pageSelect">
        <% for (let i = 0; i < data.length; i++) { %>
          <option value="<%= data[i]._id %>"><%= data[i].metadata.title %></option>
        <% } %>
      </select>

      <button onclick="loadDataPage()" class="px-4 py-2 bg-green-700 font-semibold text-white">CARREGAR</button>
      <button onclick="deletePage()" class="px-4 py-2 bg-red-700 font-semibold text-white">APAGAR</button>
    </section>
  
    <header class="space-y-4">
      <h2 class="text-lg font-semibold">CABEÇALHO</h2>

      <div class="flex flex-col">
        <label for="titleHeader">Titulo:</label>
        <input id="titleHeader" type="text" class="px-4 py-2 border bg-gray-200">
      </div>

      <div class="flex flex-col">
        <label for="coverHeader">CAPA:</label>
        <input id="coverHeader" type="text" class="px-4 py-2 border bg-gray-200">
      </div>

      <div class="flex flex-col">
        <label for="descriptionHeader">DESCRIÇÃO:</label>
        <textarea name="" id="descriptionHeader" cols="30" rows="5" class="border bg-gray-200 p-4"></textarea>
      </div>
      
      <div class="flex flex-col">
        <label for="authorHeader">AUTOR:</label>
        <select class="border bg-gray-200" id="authorHeader">
          <option selected value="Gabriel Andrade">Gabriel Andrade</option>
        </select>
      </div>

      <div class="flex flex-col">
        <label for="categoriesHeader">CATEGORIAS:</label>
        <input id="categoriesHeader" type="text" class="px-4 py-2 border bg-gray-200" placeholder="categoria 1;; categoria 2;; categoria 3">
      </div>

      <div class="flex flex-col">
        <label for="">PALAVRAS CHAVE:</label>
        <input id="keywordsHeader" type="text" class="px-4 py-2 border bg-gray-200" placeholder="keyword 1;; keyword 2;; keyword 3">
      </div>
    </header>
    <hr class="border border-black">

    <section class="space-y-4 border">
      <h2 class="text-lg font-semibold">CONTEUDO</h2>

      <!-- CONTEUDO -->
      <section id="contentSection" class="border border-black p-4"></section>

      <!-- CONTROLES -->
      <div class="border p-4">
        <button onclick="newContent('h2')" class="px-4 py-1 bg-gray-600 text-white font-semibold">h2</button>
        <button onclick="newContent('p')" class="px-4 py-1 bg-gray-600 text-white font-semibold">p</button>
        <button onclick="newContent('img')" class="px-4 py-1 bg-gray-600 text-white font-semibold">img</button>
        <button onclick="newContent('ul')" class="px-4 py-1 bg-gray-600 text-white font-semibold">ul</button>
        <button onclick="newContent('iframe')" class="px-4 py-1 bg-gray-600 text-white font-semibold">iframe</button>
        <button onclick="newContent('blockquote')" class="px-4 py-1 bg-gray-600 text-white font-semibold">blockquote</button>
        <button onclick="newContent('a')" class="px-4 py-1 bg-gray-600 text-white font-semibold">a</button>
      </div>
    </section>
    <button onclick="update()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 w-full">ATUALIZAR POST</button>
  </main>
</body>
</html>


<script>
  function deletePage(id){
    const pageID = document.getElementById('pageSelect').value
    const pass = prompt('APAGAR ESTA PAGINA?, DIGITE SUA SENHA.')
    if(pass == '22052719' && pageID){
      fetch('/post/'+pageID,{
        method: 'DELETE',
      })
      .then((res)=>{
        console.log(res)
        alert('APAGADO COM SUCESSO')
        window.location.reload()
      })
      .catch((err)=>{
        console.log(err)
        alert('ERRO AO APAGRA PAGINA!')
      })
    }else{
      alert('SENHA ERRADA!')
    }
  }

  function obterDataAtual() {
    function padZero(numero) {
    return numero < 10 ? `0${numero}` : numero;
    }
    const dataAtual = new Date();
      
      // Extrair dia, mês e ano da data
      const dia = padZero(dataAtual.getDate());
      const mes = padZero(dataAtual.getMonth() + 1); // Mês começa do zero, então somamos 1
      const ano = dataAtual.getFullYear();
    // Retornar os valores em um objeto
    return `${dia}/${mes}/${ano}`
  }

  function getData(){
    const data = {
      // HEADER
      metadata:{
        title: document.getElementById('titleHeader').value,
        cover: document.getElementById('coverHeader').value,
        description: document.getElementById('descriptionHeader').value,
        author: document.getElementById('authorHeader').value,
        categories: document.getElementById('categoriesHeader').value.split(';;'),
        keywords: document.getElementById('keywordsHeader').value.split(';;'),
        publicationDate: obterDataAtual()
      },
      content:[]
    }

    // CONTENT
    const itemContent = document.querySelectorAll('.itemContent')
    itemContent.forEach((e)=>{
      const typeElement = e.querySelector('h2');
      const contentElement = e.querySelector('textarea');

      const content = {
        type: typeElement.textContent.trim(), // Corrigido aqui
        content: contentElement.value.trim().includes(';;') ? contentElement.value.split(';;') : contentElement.value
      }

      data.content.push(content);

    })
    return data
  }



  //adicionar nova caixa de conteudo
  let contId = 0;
  function newContent(type, content) {
    contId++;
    const contentSection = document.querySelector('#contentSection');
    const newContentDiv = document.createElement('div');

    newContentDiv.id = 'content' + contId;
    newContentDiv.setAttribute('name', type);
    newContentDiv.innerHTML = `
    <div class="itemContent">


<div class="flex justify-between pb-2">
  <h2 class="text-lg px-4 py-1 bg-gray-600 text-white font-semibold">${type}</h2>



  <div>      
    <button onclick="removeContent('content${contId}')" class="px-4 py-1 bg-red-600 text-white font-semibold">APAGAR</button>
    <button onclick="moverPraCima('content${contId}')">
      <div class="w-10 h-10 bg-blue-500 hover:bg-blue-700 duration-200 flex items-center text-white justify-center">
        <i class="fa-solid fa-up-long"></i>
      </div>
    </button>
    <button onclick="moverPraBaixo('content${contId}')">
      <div class="w-10 h-10 bg-blue-500 hover:bg-blue-700 duration-200 flex items-center text-white justify-center">
        <i class="fa-solid fa-down-long"></i>
      </div>
    </button>
    
    
  </div>
</div>
<textarea name="" id="" cols="30" rows="1" class="border w-full min-h-20 max-h-34 p-4" placeholder="${type == 'h2' ? 'subtitulo...' : type == 'p' ? 'paragrafo' : type == 'img' ? 'link de imagem' : type == 'ul' ? 'item 1;; item 2;; item 3' : type == 'iframe' ? 'link de iframe' : type == 'blockquote' ? 'citação...' : type == 'a' ? 'link;; texto' : 'não identificado!'}">
  ${typeof content !== 'undefined' && 'undefined' ? content : ''}
</textarea>
</div>
    `;

    contentSection.appendChild(newContentDiv);
  }

  function removeContent(id){
    document.querySelector('#'+id).remove()
  }

  async function update(){
    const pageSelect = document.getElementById('pageSelect').value
    const data = await getData()
    fetch('/post/'+pageSelect,{
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(data)
    })
    .then((res)=>{
      console.log(res)
      alert('POST ATUALIZADO COM SUCESSO!')
    })
    .catch((err)=>{
      console.log(err)
      alert('ERRO AO ATUALIZADO POST!')
    })
  }


  //carregar dados da pagina
  function loadDataPage(){
    const pageSelect = document.getElementById('pageSelect').value
    console.log('/post/'+pageSelect)
    fetch('/post/'+pageSelect,{
      method: 'GET',
    })
    .then(res => res.json())
    .then((res)=>{
      console.log(res)
      writeDataInPage(res)
  
    })
    .catch((err)=>{
      console.log(err)
    })
  }



  function writeDataInPage(data){
    // HEADER
    document.getElementById('titleHeader').value = data.metadata.title
    document.getElementById('coverHeader').value = data.metadata.cover
    document.getElementById('descriptionHeader').value = data.metadata.description
    document.getElementById('authorHeader').value = data.metadata.author

    let categoriesHeader = data.metadata.categories.map(category => category.replace(/,/g, ';;')).join(';;');
    let keywordsHeader = data.metadata.keywords.map(keyword => keyword.replace(/,/g, ';;')).join(';;');

    document.getElementById('categoriesHeader').value = categoriesHeader;
    document.getElementById('keywordsHeader').value = keywordsHeader;

  
    // CONTENT
    data.content.forEach((e) => {
    if (e.type === 'ul' || e.type === 'a') {
        if (Array.isArray(e.content)) {
            // Aqui, e.content é um array
            const contentWithDoubleSemicolon = e.content.join(';;');
            newContent(e.type, contentWithDoubleSemicolon);
        } else if (typeof e.content === 'string') {
            // Aqui, e.content é uma string
            const text = e.content.replace(/,/g, ';;');
            newContent(e.type, text);
        } else {
            console.error('O conteúdo não é uma string ou um array:', e.content);
        }
    } else {
        // Aqui, e.content é uma string
        newContent(e.type, e.content);
    }
});





 
  }
  

</script>

<script>
  function moverPraCima(contentId) {
    const contentDiv = document.getElementById(contentId);

    if (contentDiv) {
      const contentSection = document.querySelector('#contentSection');
      const index = Array.from(contentSection.children).indexOf(contentDiv);

      if (index > 0) {
        contentSection.insertBefore(contentDiv, contentSection.children[index - 1]);
      }
    }
  }

  function moverPraBaixo(contentId) {
  const contentDiv = document.getElementById(contentId);

  if (contentDiv) {
    const contentSection = document.querySelector('#contentSection');
    const index = Array.from(contentSection.children).indexOf(contentDiv);

    if (index < contentSection.children.length - 1) {
      contentSection.insertBefore(contentDiv, contentSection.children[index + 2]);
    }
  }
}



</script>